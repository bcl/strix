<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset=UTF-8>
    <meta name="viewport" content="width=device-width">
    <title>Strix - Motion Camera UI - Camera Events</title>
    <link href="/style.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <div id="topview">
    <div id="viewer">
        <video controls autoplay=false playsinline=true></video>
    </div>
    <div id="days">
        <ul id="daylinks">
            <li><a id="scrollback" onclick="">Jump Back</a></li>
        </ul>
    </div>
    </div>
    <div id="events"></div>


<script type="text/javascript">
var camera_events;

function nice_time_string(time_str) {
    var d = new Date(time_str);
    return nice_short_time_string(time_str) + " " + d.toLocaleTimeString();
}

function nice_short_time_string(time_str) {
    var d = new Date(time_str);
    // DoW Mo Day Year
    var fields = d.toDateString().split(" ");
    return fields.slice(0,3).join(" ");
}

function add_day(starttime) {
    let newLi = document.createElement("li");
    let newDay = document.createElement("a");
    newDay.innerHTML = nice_short_time_string(starttime);
    newDay.href = `#${starttime}`;
    newLi.appendChild(newDay);

    document.querySelector("#daylinks").appendChild(newLi);
}

function get_all_events(camera_name) {
    var last_start = 0;

    // The API returns the events with the oldest one first in the .events list
    fetch("/api/events/"+camera_name+"?limit=0")
        .then(resp => resp.json())
        .then(data => {
            // Save for onclick actions
            camera_events = data.events[camera_name];
            var events = document.querySelector("#events");

            // off-screen image used for onload to get width and height
            let oneImg = document.createElement("img");
            oneImg.onload = function() {
                width = this.width;
                height = this.height;
                html = data.events[camera_name].reverse().map(event => {
                    let alt = nice_time_string(event.start);
                    let html = `<img class="thumbnail"
                            onclick="javascript:load_viewer('${event.video}', scrollY);"
                            title="${alt}"
                            loading="lazy"
                            width=${width}
                            height=${height}
                            src="${event.thumbnail}" />`
                        // Show a day banner every time it passes midnight
                        let od = new Date(last_start).getDay();
                        let nd = new Date(event.start).getDay();
                        if (last_start == 0) {
                            banner = `<div class="newday" id="${event.start}"><h1 align="center">${alt}</h1>`;
                            html = banner + html;
                        }
                        else if (od != nd) {
                            banner = `</div><div class="newday" id="${event.start}"><h1 align="center">${alt}</h1>`;
                            html = banner + html;
                            add_day(event.start);
                        }
                        last_start = event.start;
                        return html;
                }).join("");
                events.innerHTML = html + "</div>";
            }
            // Load the 1st thumbnail, triggering onload for it
            oneImg.src = data.events[camera_name][0].thumbnail;
        });
}

function load_viewer(event, scrollY) {
    scroll(0,0);

    // Set the viewere to the event video
    var viewer = document.querySelector("#viewer video");
    viewer.src = event;
    viewer.autoplay = true;

    // Setup the scrollback link
    var sb = document.querySelector("#scrollback");
    sb.onclick = function() {scroll(0, scrollY);};
}

function setup_page() {
    let params = new URLSearchParams(document.location.search);
    let camera = params.get("camera");
    if (camera == null) {
        return;
    }
    let event = params.get("event");

    // Get the events for this camera from the API server and populate the page
    get_all_events(camera);

    // Load the viewer with the event, if one was selected
    if (event != null) {
        load_viewer(event, 0);
    }
}

setup_page();
</script>
</body>
</html>
